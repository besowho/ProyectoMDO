<pre class="code">
<span class="srcline"><span class="lineno"><a href="213,25" id="srcline25"> 25</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="213,26" id="srcline26"> 26</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="213,27" id="srcline27"> 27</a></span><span class="line"><span class="comment">%--------------------------------------------------------------------------</span></span></span>
<span class="srcline"><span class="lineno"><a href="213,28" id="srcline28"> 28</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="213,29" id="srcline29"> 29</a></span><span class="line"><span class="keyword">function</span> [<span class="var type1" id="S18T344U105">bbs_out</span>, <span class="var type1" id="S19T388U106">selected_out</span>] = mergeByProximity(<span class="var type1" id="S20T344U109">bbs</span>)</span></span>
<span class="srcline"><span class="lineno"><a href="213,30" id="srcline30"> 30</a></span><span class="line"><span class="comment">%#codegen</span></span></span>
<span class="srcline"><span class="lineno"><a href="213,31" id="srcline31"> 31</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="213,32" id="srcline32"> 32</a></span><span class="line"><span class="mxinfo " id="T41:U4"><span class="var type1" id="S21T41U112">s</span> = <span class="mxinfo " id="T41:U6"><span class="mxinfo " id="T41:U7"><span class="var type1" id="S20T344U115">bbs</span>(:,<span class="mxinfo " id="T4:U9">3</span>)</span>.*<span class="mxinfo " id="T41:U10"><span class="var type1" id="S20T344U119">bbs</span>(:,<span class="mxinfo " id="T4:U12">4</span>)</span></span></span> ;</span></span>
<span class="srcline"><span class="lineno"><a href="213,33" id="srcline33"> 33</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="213,34" id="srcline34"> 34</a></span><span class="line"><span class="mxinfo " id="T4:U13"><span class="var type1" id="S22T4U124">numbbs</span>=<span class="mxinfo " id="T4:U15">size(<span class="var type1" id="S20T344U127">bbs</span>,1)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="213,35" id="srcline35"> 35</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="213,36" id="srcline36"> 36</a></span><span class="line">[<span class="mxinfo " id="T4:U17"><span class="mxinfo " id="T4:U18">~</span></span>, <span class="mxinfo " id="T41:U19"><span class="var type1" id="S24T41U133">ordr</span></span>] = sort(<span class="var type1" id="S21T41U136">s</span>, <span class="string">'descend'</span>) ;</span></span>
<span class="srcline"><span class="lineno"><a href="213,37" id="srcline37"> 37</a></span><span class="line"><span class="mxinfo " id="T344:U22"><span class="var type1" id="S20T344U140">bbs</span> = <span class="mxinfo " id="T344:U24"><span class="var type1" id="S20T344U142">bbs</span>( <span class="var type1" id="S24T41U143">ordr</span>, : )</span></span> ;</span></span>
<span class="srcline"><span class="lineno"><a href="213,38" id="srcline38"> 38</a></span><span class="line"><span class="comment">%Mu = bsxfun(@plus, bbs(:,1:2), bbs(:,3:4)/2) ;</span></span></span>
<span class="srcline"><span class="lineno"><a href="213,39" id="srcline39"> 39</a></span><span class="line"><span class="mxinfo " id="T330:U27"><span class="var type1" id="S26T330U147">Mu</span> = <span class="mxinfo " id="T330:U29"><span class="mxinfo " id="T330:U30"><span class="var type1" id="S20T344U150">bbs</span>(:,<span class="mxinfo " id="T8:U32"><span class="mxinfo " id="T4:U33">1</span>:<span class="mxinfo " id="T4:U34">2</span></span>)</span>+(<span class="mxinfo " id="T330:U35"><span class="mxinfo " id="T330:U36"><span class="var type1" id="S20T344U158">bbs</span>(:,<span class="mxinfo " id="T8:U38"><span class="mxinfo " id="T4:U39">3</span>:<span class="mxinfo " id="T4:U40">4</span></span>)</span>/<span class="mxinfo " id="T4:U41">2</span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="213,40" id="srcline40"> 40</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="213,41" id="srcline41"> 41</a></span><span class="line"><span class="mxinfo " id="T41:U42"><span class="var type1" id="S27T41U166">box_sizes</span> = <span class="mxinfo " id="T41:U44"><span class="mxinfo " id="T41:U45">sum(<span class="mxinfo " id="T330:U46"><span class="var type1" id="S20T344U171">bbs</span>(:,<span class="mxinfo " id="T8:U48"><span class="mxinfo " id="T4:U49">3</span>:<span class="mxinfo " id="T4:U50">4</span></span>)</span>,2)</span>/<span class="mxinfo " id="T4:U51">2</span></span></span> ;</span></span>
<span class="srcline"><span class="lineno"><a href="213,42" id="srcline42"> 42</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="213,43" id="srcline43"> 43</a></span><span class="line"><span class="mxinfo " id="T330:U52"><span class="var type1" id="S29T330U180">Covs</span> = <span class="mxinfo " id="T330:U54">(<span class="mxinfo " id="T330:U55"><span class="mxinfo " id="T330:U56"><span class="mxinfo " id="T330:U57"><span class="var type1" id="S20T344U186">bbs</span>(:,<span class="mxinfo " id="T8:U59"><span class="mxinfo " id="T4:U60">3</span>:<span class="mxinfo " id="T4:U61">4</span></span>)</span>*<span class="mxinfo " id="T4:U62">1</span></span>+<span class="mxinfo " id="T4:U63">5</span></span>).^2</span></span> ;</span></span>
<span class="srcline"><span class="lineno"><a href="213,44" id="srcline44"> 44</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="213,45" id="srcline45"> 45</a></span><span class="line"><span class="mxinfo " id="T388:U64"><span class="var type1" id="S19T388U196">selected_out</span> = <span class="mxinfo " id="T347:U66">repmat(struct(<span class="string">'idx'</span>, []), <span class="var type1" id="S22T4U204">numbbs</span>, 1)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="213,46" id="srcline46"> 46</a></span><span class="line">coder.cstructname(<span class="var type0" id="S19T0U211">selected_out</span>, <span class="string">'SelectedIndices'</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="213,47" id="srcline47"> 47</a></span><span class="line">coder.varsize(<span class="string">'selected_out(:).idx'</span>)</span></span>
<span class="srcline"><span class="lineno"><a href="213,48" id="srcline48"> 48</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="213,49" id="srcline49"> 49</a></span><span class="line"><span class="mxinfo " id="T344:U68"><span class="var type1" id="S18T344U221">bbs_out</span> = <span class="mxinfo " id="T344:U70">zeros(<span class="var type1" id="S22T4U224">numbbs</span>,<span class="mxinfo " id="T4:U72">4</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="213,50" id="srcline50"> 50</a></span><span class="line"><span class="mxinfo " id="T4:U73"><span class="var type1" id="S34T4U228">mindist</span> = <span class="mxinfo " id="T4:U75">1</span></span> ;</span></span>
<span class="srcline"><span class="lineno"><a href="213,51" id="srcline51"> 51</a></span><span class="line"><span class="mxinfo " id="T4:U76"><span class="var type1" id="S35T4U232">counter</span>=<span class="mxinfo " id="T4:U78">1</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="213,52" id="srcline52"> 52</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="213,53" id="srcline53"> 53</a></span><span class="line"><span class="keyword">while</span> true</span></span>
<span class="srcline"><span class="lineno"><a href="213,54" id="srcline54"> 54</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="213,55" id="srcline55"> 55</a></span><span class="line">    <span class="mxinfo " id="T180:U79"><span class="var type1" id="S37T180U239">ratios</span> = <span class="mxinfo " id="T180:U81">zeros(<span class="mxinfo " id="T4:U82">1</span>, <span class="mxinfo " id="T4:U83">size(<span class="var type1" id="S20T344U245">bbs</span>,1)</span>)</span></span> ;</span></span>
<span class="srcline"><span class="lineno"><a href="213,56" id="srcline56"> 56</a></span><span class="line">    <span class="mxinfo " id="T8:U85"><span class="var type1" id="S38T8U249">C1</span> = <span class="mxinfo " id="T8:U87"><span class="var type1" id="S29T330U251">Covs</span>(<span class="mxinfo " id="T4:U89">1</span>,:)</span></span> ;</span></span>
<span class="srcline"><span class="lineno"><a href="213,57" id="srcline57"> 57</a></span><span class="line">    <span class="keyword">for</span> <span class="var type1" id="S39T4U256">i</span> = <span class="mxinfo " id="T4:U91">1</span> : <span class="mxinfo " id="T4:U92">length(<span class="var type1" id="S37T180U261">ratios</span>)</span></span></span>
<span class="srcline"><span class="lineno"><a href="213,58" id="srcline58"> 58</a></span><span class="line">        <span class="mxinfo " id="T8:U94"><span class="var type1" id="S41T8U264">C2</span> = <span class="mxinfo " id="T8:U96"><span class="var type1" id="S29T330U266">Covs</span>(<span class="var type1" id="S39T4U267">i</span>,:)</span></span> ;</span></span>
<span class="srcline"><span class="lineno"><a href="213,59" id="srcline59"> 59</a></span><span class="line">        <span class="mxinfo " id="T8:U99"><span class="var type1" id="S42T8U271">C</span> = <span class="mxinfo " id="T8:U101"><span class="var type1" id="S38T8U273">C1</span>+<span class="var type1" id="S41T8U274">C2</span></span></span> ;</span></span>
<span class="srcline"><span class="lineno"><a href="213,60" id="srcline60"> 60</a></span><span class="line">        <span class="mxinfo " id="T4:U104"><span class="mxinfo " id="T4:U105"><span class="var type1" id="S37T180U278">ratios</span>(<span class="var type1" id="S39T4U279">i</span>)</span> = <span class="mxinfo " id="T4:U108">sqrt(<span class="mxinfo " id="T4:U109">sum(<span class="mxinfo " id="T8:U110">(<span class="mxinfo " id="T8:U111">(<span class="mxinfo " id="T8:U112"><span class="mxinfo " id="T8:U113"><span class="var type1" id="S26T330U290">Mu</span>(<span class="mxinfo " id="T4:U115">1</span>,:)</span>-<span class="mxinfo " id="T8:U116"><span class="var type1" id="S26T330U294">Mu</span>(<span class="var type1" id="S39T4U295">i</span>,:)</span></span>).^2</span>)./<span class="var type1" id="S42T8U298">C</span></span>)</span>)</span></span> ;</span></span>
<span class="srcline"><span class="lineno"><a href="213,61" id="srcline61"> 61</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="213,62" id="srcline62"> 62</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="213,63" id="srcline63"> 63</a></span><span class="line">    <span class="mxinfo " id="T316:U120"><span class="var type1" id="S44T316U301">id_remove</span> = (<span class="mxinfo " id="T316:U122"><span class="var type1" id="S37T180U304">ratios</span> &lt;= <span class="mxinfo " id="T4:U124"><span class="var type1" id="S34T4U305">mindist</span></span></span>)</span> ;</span></span>
<span class="srcline"><span class="lineno"><a href="213,64" id="srcline64"> 64</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="213,65" id="srcline65"> 65</a></span><span class="line">    <span class="mxinfo " id="T13:U126"><span class="mxinfo " id="T13:U127"><span class="var type1" id="S18T344U309">bbs_out</span>(<span class="var type1" id="S35T4U310">counter</span>,:)</span> = <span class="mxinfo " id="T13:U130"><span class="fcn" id="F1830N29:B313">suppress_detections</span>( <span class="var type1" id="S20T344U314">bbs</span>, <span class="var type1" id="S26T330U315">Mu</span>, <span class="var type1" id="S44T316U316">id_remove</span>)</span></span>   ;</span></span>
<span class="srcline"><span class="lineno"><a href="213,66" id="srcline66"> 66</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="213,67" id="srcline67"> 67</a></span><span class="line">    <span class="mxinfo " id="T389:U134"><span class="mxinfo " id="T389:U135"><span class="mxinfo " id="T495:U136"><span class="var type1" id="S19T388U321">selected_out</span>(<span class="var type1" id="S35T4U322">counter</span>)</span>.idx</span> =  <span class="mxinfo " id="T41:U139"><span class="var type1" id="S24T41U325">ordr</span>(<span class="var type1" id="S44T316U326">id_remove</span>)</span></span>  ;</span></span>
<span class="srcline"><span class="lineno"><a href="213,68" id="srcline68"> 68</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="213,69" id="srcline69"> 69</a></span><span class="line">    <span class="mxinfo " id="T344:U142"><span class="var type1" id="S20T344U330">bbs</span>(<span class="var type1" id="S44T316U331">id_remove</span>, :) = []</span> ;</span></span>
<span class="srcline"><span class="lineno"><a href="213,70" id="srcline70"> 70</a></span><span class="line">    <span class="mxinfo " id="T330:U145"><span class="var type1" id="S26T330U338">Mu</span>(<span class="var type1" id="S44T316U339">id_remove</span>, :) = []</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="213,71" id="srcline71"> 71</a></span><span class="line">    <span class="mxinfo " id="T41:U148"><span class="var type1" id="S24T41U346">ordr</span>(<span class="var type1" id="S44T316U347">id_remove</span>) = []</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="213,72" id="srcline72"> 72</a></span><span class="line">    <span class="mxinfo " id="T330:U151"><span class="var type1" id="S29T330U353">Covs</span> (<span class="var type1" id="S44T316U354">id_remove</span>, :) = []</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="213,73" id="srcline73"> 73</a></span><span class="line">    <span class="mxinfo " id="T41:U154"><span class="var type1" id="S27T41U361">box_sizes</span>(<span class="var type1" id="S44T316U362">id_remove</span>) = []</span>  ;</span></span>
<span class="srcline"><span class="lineno"><a href="213,74" id="srcline74"> 74</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="213,75" id="srcline75"> 75</a></span><span class="line">    <span class="keyword">if</span> <span class="mxinfo " id="T2:U157">isempty(<span class="var type1" id="S26T330U369">Mu</span>)</span></span></span>
<span class="srcline"><span class="lineno"><a href="213,76" id="srcline76"> 76</a></span><span class="line">        <span class="keyword">break</span> ;</span></span>
<span class="srcline"><span class="lineno"><a href="213,77" id="srcline77"> 77</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="213,78" id="srcline78"> 78</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="213,79" id="srcline79"> 79</a></span><span class="line">    <span class="mxinfo " id="T4:U159"><span class="var type1" id="S35T4U373">counter</span>=<span class="mxinfo " id="T4:U161"><span class="var type1" id="S35T4U375">counter</span>+<span class="mxinfo " id="T4:U163">1</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="213,80" id="srcline80"> 80</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="213,81" id="srcline81"> 81</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="213,82" id="srcline82"> 82</a></span><span class="line"><span class="mxinfo " id="T388:U164"><span class="var type1" id="S19T388U379">selected_out</span>=<span class="mxinfo " id="T388:U166"><span class="var type1" id="S19T388U381">selected_out</span>(<span class="mxinfo " id="T4:U168">1</span>:<span class="var type1" id="S35T4U384">counter</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="213,83" id="srcline83"> 83</a></span><span class="line"><span class="mxinfo " id="T344:U170"><span class="var type1" id="S18T344U387">bbs_out</span>=<span class="mxinfo " id="T344:U172"><span class="var type1" id="S18T344U389">bbs_out</span>(<span class="mxinfo " id="T2:U174"><span class="mxinfo " id="T4:U175">1</span>:<span class="var type1" id="S35T4U392">counter</span></span>,:)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="213,84" id="srcline84"> 84</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="213,85" id="srcline85"> 85</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="213,86" id="srcline86"> 86</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="213,87" id="srcline87"> 87</a></span><span class="line"><span class="comment">%--------------------------------------------------------------------------</span></span></span>
<span class="srcline"><span class="lineno"><a href="213,88" id="srcline88"> 88</a></span><span class="line"></span></span>
</pre>
