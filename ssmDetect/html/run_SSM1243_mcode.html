<pre class="code">
<span class="srcline"><span class="lineno"><a href="190,1" id="srcline1">  1</a></span><span class="line"><span class="keyword">function</span> [ <span class="var type1" id="S2T1U3">detector_state</span>, <span class="var type1" id="S3T351U4">Q_sum_large</span> ] = run_SSM(<span class="mxinfo " id="T1:U3"><span class="mxinfo " id="T1:U4"><span class="var type1" id="S2T1U7">detector_state</span></span></span>, <span class="var type1" id="S4T61U8">data</span>)</span></span>
<span class="srcline"><span class="lineno"><a href="190,2" id="srcline2">  2</a></span><span class="line"><span class="comment">% not coder-compatible but maybe more readable to a user</span></span></span>
<span class="srcline"><span class="lineno"><a href="190,3" id="srcline3">  3</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="190,4" id="srcline4">  4</a></span><span class="line"><span class="comment">% read the em parameters</span></span></span>
<span class="srcline"><span class="lineno"><a href="190,5" id="srcline5">  5</a></span><span class="line"><span class="mxinfo " id="T4:U7"><span class="var type1" id="S5T4U11">p_unknown</span> = <span class="mxinfo " id="T4:U9"><span class="fcn" id="F429N13:B13">getUnknownWeightForTheFeatureModel</span>(<span class="mxinfo " id="T3:U10"><span class="var type1" id="S2T1U15">detector_state</span>.colorspace</span>, <span class="mxinfo " id="T8:U12"><span class="var type1" id="S2T1U18">detector_state</span>.em_image_size</span>, <span class="mxinfo " id="T2:U14"><span class="var type1" id="S2T1U21">detector_state</span>.use_uniform_component</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="190,6" id="srcline6">  6</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="190,7" id="srcline7">  7</a></span><span class="line"><span class="mxinfo " id="T4:U16"><span class="var type1" id="S7T4U25">maxEMsteps</span> = <span class="mxinfo " id="T4:U18"><span class="var type1" id="S2T1U27">detector_state</span>.em_max_steps</span></span>; <span class="comment">% maximum number of em steps</span></span></span>
<span class="srcline"><span class="lineno"><a href="190,8" id="srcline8">  8</a></span><span class="line"><span class="mxinfo " id="T8:U20"><span class="var type1" id="S8T8U31">mask_size</span> = <span class="mxinfo " id="T8:U22">[50, 50]</span></span>; <span class="comment">%mask_size = detector_state.em_image_size;</span></span></span>
<span class="srcline"><span class="lineno"><a href="190,9" id="srcline9">  9</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="190,10" id="srcline10"> 10</a></span><span class="line"><span class="comment">% construct convolution kernels for the em posteriors</span></span></span>
<span class="srcline"><span class="lineno"><a href="190,11" id="srcline11"> 11</a></span><span class="line"><span class="comment">%[H_0, H_1] = getConvolutionKernel(mask_size);</span></span></span>
<span class="srcline"><span class="lineno"><a href="190,12" id="srcline12"> 12</a></span><span class="line"><span class="mxinfo " id="T89:U23"><span class="var type1" id="S9T89U38">H_0</span> = <span class="mxinfo " id="T89:U25">[0.0613    0.1887    0.0613; 0.1887         0    0.1887; 0.0613    0.1887    0.0613]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="190,13" id="srcline13"> 13</a></span><span class="line"><span class="mxinfo " id="T89:U26"><span class="var type1" id="S10T89U54">H_1</span> = <span class="mxinfo " id="T89:U28">[0.0613    0.1887    0.0613; 0.1887    1.0000    0.1887; 0.0613    0.1887    0.0613]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="190,14" id="srcline14"> 14</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="190,15" id="srcline15"> 15</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="190,16" id="srcline16"> 16</a></span><span class="line"><span class="comment">% number of components in the mixture model</span></span></span>
<span class="srcline"><span class="lineno"><a href="190,17" id="srcline17"> 17</a></span><span class="line"><span class="mxinfo " id="T4:U29"><span class="var type1" id="S11T4U70">mixture_size</span> = <span class="mxinfo " id="T4:U31">length(<span class="var type1" id="S2T1U74">detector_state</span>.current_mixture)</span></span> ;</span></span>
<span class="srcline"><span class="lineno"><a href="190,18" id="srcline18"> 18</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="190,19" id="srcline19"> 19</a></span><span class="line"><span class="comment">% intialize mixtures</span></span></span>
<span class="srcline"><span class="lineno"><a href="190,20" id="srcline20"> 20</a></span><span class="line"><span class="keyword">if</span> isempty(<span class="var type1" id="S2T1U81">detector_state</span>.PI_i)</span></span>
<span class="srcline"><span class="lineno"><a href="190,21" id="srcline21"> 21</a></span><span class="line">    <span class="var type0" id="S14T0U85">PI_i</span> = ones(<span class="var type0" id="S8T0U90">mask_size</span>(2), <span class="var type0" id="S8T0U93">mask_size</span>(1), <span class="var type0" id="S11T0U96">mixture_size</span>+1) /(<span class="var type0" id="S11T0U100">mixture_size</span>+1) ;</span></span>
<span class="srcline"><span class="lineno"><a href="190,22" id="srcline22"> 22</a></span><span class="line">    <span class="var type0" id="S14T0U105">PI_i</span>(:,:,1:3) = 1/<span class="var type0" id="S11T0U114">mixture_size</span> - <span class="var type0" id="S5T0U116">p_unknown</span>/<span class="var type0" id="S11T0U117">mixture_size</span> ;</span></span>
<span class="srcline"><span class="lineno"><a href="190,23" id="srcline23"> 23</a></span><span class="line">    <span class="var type0" id="S14T0U121">PI_i</span>(:,:,4) = <span class="var type0" id="S5T0U125">p_unknown</span> ;</span></span>
<span class="srcline"><span class="lineno"><a href="190,24" id="srcline24"> 24</a></span><span class="line"><span class="keyword">else</span></span></span>
<span class="srcline"><span class="lineno"><a href="190,25" id="srcline25"> 25</a></span><span class="line">    <span class="mxinfo " id="T10:U34"><span class="var type1" id="S14T10U129">PI_i</span> = <span class="mxinfo " id="T10:U36"><span class="var type1" id="S2T1U131">detector_state</span>.PI_i</span></span> ;</span></span>
<span class="srcline"><span class="lineno"><a href="190,26" id="srcline26"> 26</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="190,27" id="srcline27"> 27</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="190,28" id="srcline28"> 28</a></span><span class="line"><span class="comment">% initialize the posterior for checking stopping condition</span></span></span>
<span class="srcline"><span class="lineno"><a href="190,29" id="srcline29"> 29</a></span><span class="line"><span class="mxinfo " id="T10:U38"><span class="var type1" id="S16T10U135">PI_i0</span> = <span class="var type1" id="S14T10U136">PI_i</span></span> ;<span class="comment">% dbug</span></span></span>
<span class="srcline"><span class="lineno"><a href="190,30" id="srcline30"> 30</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="190,31" id="srcline31"> 31</a></span><span class="line"><span class="mxinfo " id="T4:U41"><span class="var type1" id="S17T4U139">cont</span> = <span class="var type1" id="S7T4U140">maxEMsteps</span></span> ; <span class="comment">% 100 ;</span></span></span>
<span class="srcline"><span class="lineno"><a href="190,32" id="srcline32"> 32</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="190,33" id="srcline33"> 33</a></span><span class="line"><span class="mxinfo " id="T351:U44"><span class="var type1" id="S18T351U143">Q_sum</span>=<span class="mxinfo " id="T46:U46">[]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="190,34" id="srcline34"> 34</a></span><span class="line"><span class="comment">%Q_sum_temp = cat(3,zeros(50,50),zeros(50,50),zeros(50,50),zeros(50,50));</span></span></span>
<span class="srcline"><span class="lineno"><a href="190,35" id="srcline35"> 35</a></span><span class="line"><span class="comment">%Q_sum = Q_sum_temp;</span></span></span>
<span class="srcline"><span class="lineno"><a href="190,36" id="srcline36"> 36</a></span><span class="line"><span class="mxinfo " id="T85:U47"><span class="var type1" id="S19T85U148">p</span> = <span class="mxinfo " id="T85:U49">zeros(<span class="mxinfo " id="T4:U50"><span class="var type1" id="S11T4U152">mixture_size</span>+1</span>,<span class="mxinfo " id="T4:U52">size(<span class="var type1" id="S4T61U156">data</span>,2)</span>)</span></span> ;</span></span>
<span class="srcline"><span class="lineno"><a href="190,37" id="srcline37"> 37</a></span><span class="line"> <span class="keyword">while</span> <span class="mxinfo " id="T2:U54"><span class="var type1" id="S17T4U160">cont</span> &gt; <span class="mxinfo " id="T4:U56">1</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="190,38" id="srcline38"> 38</a></span><span class="line">    <span class="comment">% get responsibilities</span></span></span>
<span class="srcline"><span class="lineno"><a href="190,39" id="srcline39"> 39</a></span><span class="line">    <span class="keyword">for</span> <span class="var type1" id="S22T4U164">i</span> = <span class="mxinfo " id="T4:U58">1</span> : <span class="var type1" id="S11T4U167">mixture_size</span></span></span>
<span class="srcline"><span class="lineno"><a href="190,40" id="srcline40"> 40</a></span><span class="line">        <span class="mxinfo " id="T214:U60"><span class="mxinfo " id="T214:U61"><span class="var type1" id="S19T85U171">p</span>(<span class="var type1" id="S22T4U172">i</span>,:)</span> = <span class="mxinfo " id="T84:U64"><span class="fcn" id="F597N20:B175">normpdf</span>(<span class="var type1" id="S4T61U176">data</span>,<span class="mxinfo " id="T6:U66"><span class="mxinfo " id="T15:U67"><span class="mxinfo " id="T5:U68"><span class="var type1" id="S2T1U180">detector_state</span>.current_mixture</span>(<span class="var type1" id="S22T4U182">i</span>)</span>.Mu</span>,[], <span class="mxinfo " id="T7:U71"><span class="mxinfo " id="T15:U72"><span class="mxinfo " id="T5:U73"><span class="var type1" id="S2T1U189">detector_state</span>.current_mixture</span>(<span class="var type1" id="S22T4U191">i</span>)</span>.Cov</span>)</span></span> ;</span></span>
<span class="srcline"><span class="lineno"><a href="190,41" id="srcline41"> 41</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="190,42" id="srcline42"> 42</a></span><span class="line">    <span class="mxinfo " id="T214:U76"><span class="mxinfo " id="T214:U77"><span class="var type1" id="S19T85U196">p</span>(<span class="var type1" id="S11T4U198">mixture_size</span>+1,:)</span> = <span class="var type1" id="S5T4U201">p_unknown</span></span> ;</span></span>
<span class="srcline"><span class="lineno"><a href="190,43" id="srcline43"> 43</a></span><span class="line">     </span></span>
<span class="srcline"><span class="lineno"><a href="190,44" id="srcline44"> 44</a></span><span class="line">    <span class="comment">% for the paper:</span></span></span>
<span class="srcline"><span class="lineno"><a href="190,45" id="srcline45"> 45</a></span><span class="line">    <span class="mxinfo " id="T10:U81"><span class="var type1" id="S24T10U204">P_i</span> = <span class="mxinfo " id="T10:U83"><span class="mxinfo " id="T10:U84"><span class="var type1" id="S14T10U207">PI_i</span>.*<span class="mxinfo " id="T10:U86">reshape(<span class="mxinfo " id="T86:U87"><span class="var type1" id="S19T85U211">p</span>'</span>, <span class="var type1" id="S8T8U213">mask_size</span>(2),<span class="var type1" id="S8T8U216">mask_size</span>(1), <span class="var type1" id="S11T4U219">mixture_size</span>+1)</span></span> + <span class="mxinfo " id="T4:U92">eps</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="190,46" id="srcline46"> 46</a></span><span class="line">    <span class="keyword">if</span> <span class="mxinfo " id="T2:U93">~<span class="mxinfo " id="T2:U94"><span class="var type1" id="S2T1U227">detector_state</span>.use_uniform_component</span></span>,</span></span>
<span class="srcline"><span class="lineno"><a href="190,47" id="srcline47"> 47</a></span><span class="line">        <span class="mxinfo " id="T53:U96"><span class="mxinfo " id="T53:U97"><span class="var type1" id="S24T10U232">P_i</span>(:,:,<span class="var type1" id="S11T4U236">mixture_size</span>+1)</span> = <span class="mxinfo " id="T4:U100">0</span></span> ;</span></span>
<span class="srcline"><span class="lineno"><a href="190,48" id="srcline48"> 48</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="190,49" id="srcline49"> 49</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="190,50" id="srcline50"> 50</a></span><span class="line">    <span class="comment">% perform Expectation on prior and posterior</span></span></span>
<span class="srcline"><span class="lineno"><a href="190,51" id="srcline51"> 51</a></span><span class="line">    <span class="mxinfo " id="T10:U101"><span class="var type1" id="S24T10U241">P_i</span> = <span class="mxinfo " id="T10:U103">bsxfun(@times, <span class="var type1" id="S24T10U246">P_i</span>, <span class="mxinfo " id="T53:U105"><span class="mxinfo " id="T4:U106">1</span>./<span class="mxinfo " id="T53:U107">sum(<span class="var type1" id="S24T10U251">P_i</span>,3)</span></span>)</span></span> ;   </span></span>
<span class="srcline"><span class="lineno"><a href="190,52" id="srcline52"> 52</a></span><span class="line">    <span class="mxinfo " id="T10:U109"><span class="var type1" id="S30T10U255">S_i_temp</span> = <span class="mxinfo " id="T10:U111"><span class="var type1" id="S14T10U257">PI_i</span>.*<span class="mxinfo " id="T10:U113">reshape(<span class="mxinfo " id="T362:U114">imfilter(<span class="var type1" id="S14T10U262">PI_i</span> , <span class="var type1" id="S9T89U263">H_0</span>, <span class="string">'replicate'</span>)</span>, 50, 50, 4)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="190,53" id="srcline53"> 53</a></span><span class="line">    <span class="mxinfo " id="T10:U117"><span class="var type1" id="S32T10U270">S_i</span> = <span class="mxinfo " id="T10:U119">bsxfun(@times, <span class="var type1" id="S30T10U275">S_i_temp</span>, <span class="mxinfo " id="T53:U121"><span class="mxinfo " id="T4:U122">1</span>./<span class="mxinfo " id="T53:U123">sum(<span class="var type1" id="S30T10U280">S_i_temp</span>,3)</span></span>)</span></span> ;  </span></span>
<span class="srcline"><span class="lineno"><a href="190,54" id="srcline54"> 54</a></span><span class="line">    <span class="mxinfo " id="T10:U125"><span class="var type1" id="S33T10U284">Q_i_temp</span> = <span class="mxinfo " id="T10:U127"><span class="var type1" id="S24T10U286">P_i</span>.*<span class="mxinfo " id="T10:U129">reshape(<span class="mxinfo " id="T362:U130">imfilter(<span class="var type1" id="S24T10U291">P_i</span> , <span class="var type1" id="S9T89U292">H_0</span>, <span class="string">'replicate'</span>)</span>, 50 ,50, 4)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="190,55" id="srcline55"> 55</a></span><span class="line">    <span class="mxinfo " id="T10:U133"><span class="var type1" id="S34T10U299">Q_i</span> = <span class="mxinfo " id="T10:U135">bsxfun(@times, <span class="var type1" id="S33T10U304">Q_i_temp</span>, <span class="mxinfo " id="T53:U137"><span class="mxinfo " id="T4:U138">1</span>./<span class="mxinfo " id="T53:U139">sum(<span class="var type1" id="S33T10U309">Q_i_temp</span>,3)</span></span>)</span></span> ;</span></span>
<span class="srcline"><span class="lineno"><a href="190,56" id="srcline56"> 56</a></span><span class="line">    <span class="mxinfo " id="T351:U141"><span class="var type1" id="S18T351U313">Q_sum</span> = <span class="mxinfo " id="T10:U143">reshape(<span class="mxinfo " id="T362:U144">imfilter(<span class="var type1" id="S34T10U318">Q_i</span> , <span class="var type1" id="S10T89U319">H_1</span>, <span class="string">'replicate'</span>)</span>, 50, 50, 4)</span></span> ;</span></span>
<span class="srcline"><span class="lineno"><a href="190,57" id="srcline57"> 57</a></span><span class="line">    <span class="mxinfo " id="T10:U147"><span class="var type1" id="S35T10U326">S_sum</span> = <span class="mxinfo " id="T10:U149">reshape(<span class="mxinfo " id="T362:U150">imfilter(<span class="var type1" id="S32T10U331">S_i</span> , <span class="var type1" id="S10T89U332">H_1</span>, <span class="string">'replicate'</span>)</span>, 50, 50, 4)</span></span> ;</span></span>
<span class="srcline"><span class="lineno"><a href="190,58" id="srcline58"> 58</a></span><span class="line">    <span class="mxinfo " id="T10:U153"><span class="var type1" id="S14T10U339">PI_i</span> = <span class="mxinfo " id="T10:U155">(<span class="mxinfo " id="T10:U156"><span class="var type1" id="S18T351U343">Q_sum</span> + <span class="var type1" id="S35T10U344">S_sum</span></span>)*<span class="mxinfo " id="T4:U159">0.25</span></span></span> ; <span class="comment">%</span></span></span>
<span class="srcline"><span class="lineno"><a href="190,59" id="srcline59"> 59</a></span><span class="line"> </span></span>
<span class="srcline"><span class="lineno"><a href="190,60" id="srcline60"> 60</a></span><span class="line">    <span class="comment">% if not using the uniform component, set to zero</span></span></span>
<span class="srcline"><span class="lineno"><a href="190,61" id="srcline61"> 61</a></span><span class="line">    <span class="keyword">if</span> <span class="mxinfo " id="T2:U160">~<span class="mxinfo " id="T2:U161"><span class="var type1" id="S2T1U350">detector_state</span>.use_uniform_component</span></span>,</span></span>
<span class="srcline"><span class="lineno"><a href="190,62" id="srcline62"> 62</a></span><span class="line">        <span class="mxinfo " id="T53:U163"><span class="mxinfo " id="T53:U164"><span class="var type1" id="S14T10U355">PI_i</span>(:,:,<span class="var type1" id="S11T4U359">mixture_size</span>+1)</span> = <span class="mxinfo " id="T4:U167">0</span></span> ;</span></span>
<span class="srcline"><span class="lineno"><a href="190,63" id="srcline63"> 63</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="190,64" id="srcline64"> 64</a></span><span class="line">   </span></span>
<span class="srcline"><span class="lineno"><a href="190,65" id="srcline65"> 65</a></span><span class="line">    <span class="mxinfo " id="T85:U168"><span class="var type1" id="S19T85U364">p</span> = <span class="mxinfo " id="T85:U170"><span class="mxinfo " id="T86:U171">reshape(<span class="var type1" id="S18T351U368">Q_sum</span>,<span class="var type1" id="S8T8U371">mask_size</span>(2)*<span class="var type1" id="S8T8U374">mask_size</span>(1),<span class="var type1" id="S11T4U377">mixture_size</span>+1)</span>'</span></span> ;</span></span>
<span class="srcline"><span class="lineno"><a href="190,66" id="srcline66"> 66</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="190,67" id="srcline67"> 67</a></span><span class="line">    <span class="comment">% measure the change in posterior distribution</span></span></span>
<span class="srcline"><span class="lineno"><a href="190,68" id="srcline68"> 68</a></span><span class="line">    <span class="mxinfo " id="T53:U176"><span class="var type1" id="S36T53U381">d_pi</span> = <span class="mxinfo " id="T53:U178">sum((<span class="mxinfo " id="T10:U179"><span class="mxinfo " id="T10:U180">sqrt(<span class="var type1" id="S16T10U388">PI_i0</span>)</span>-<span class="mxinfo " id="T10:U182">sqrt(<span class="var type1" id="S14T10U391">PI_i</span>)</span></span>),3)</span></span> ;</span></span>
<span class="srcline"><span class="lineno"><a href="190,69" id="srcline69"> 69</a></span><span class="line">    <span class="mxinfo " id="T84:U184"><span class="var type1" id="S36T84U395">d_pi</span> = <span class="mxinfo " id="T84:U186">sort(<span class="mxinfo " id="T84:U187"><span class="var type1" id="S36T53U399">d_pi</span>(:)</span>)</span></span> ;  <span class="mxinfo " id="T4:U189"><span class="var type1" id="S39T4U403">Loglik_new</span> = <span class="mxinfo " id="T4:U191">mean(<span class="mxinfo " id="T213:U192"><span class="var type1" id="S36T84U407">d_pi</span>(<span class="mxinfo " id="T449:U194"><span class="mxinfo " id="T4:U195">round(length(<span class="var type1" id="S36T84U414">d_pi</span>))/2</span>:<span class="mxinfo " id="T4:U197">end</span></span>)</span>)</span></span> ;</span></span>
<span class="srcline"><span class="lineno"><a href="190,70" id="srcline70"> 70</a></span><span class="line">    <span class="keyword">if</span> <span class="mxinfo " id="T2:U198"><span class="var type1" id="S39T4U421">Loglik_new</span> &gt; <span class="mxinfo " id="T4:U200">0.01</span></span> </span></span>
<span class="srcline"><span class="lineno"><a href="190,71" id="srcline71"> 71</a></span><span class="line">        <span class="mxinfo " id="T10:U201"><span class="var type1" id="S16T10U425">PI_i0</span> = <span class="var type1" id="S14T10U426">PI_i</span></span> ;<span class="comment">% dbug</span></span></span>
<span class="srcline"><span class="lineno"><a href="190,72" id="srcline72"> 72</a></span><span class="line">    <span class="keyword">else</span></span></span>
<span class="srcline"><span class="lineno"><a href="190,73" id="srcline73"> 73</a></span><span class="line">        <span class="keyword">break</span> ;</span></span>
<span class="srcline"><span class="lineno"><a href="190,74" id="srcline74"> 74</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="190,75" id="srcline75"> 75</a></span><span class="line">    <span class="mxinfo " id="T214:U204"><span class="var type1" id="S43T214U431">lp</span> = <span class="mxinfo " id="T214:U206">sum(<span class="var type1" id="S19T85U434">p</span>,1)</span></span> ;</span></span>
<span class="srcline"><span class="lineno"><a href="190,76" id="srcline76"> 76</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="190,77" id="srcline77"> 77</a></span><span class="line">    <span class="comment">% normalize posterior</span></span></span>
<span class="srcline"><span class="lineno"><a href="190,78" id="srcline78"> 78</a></span><span class="line">    <span class="mxinfo " id="T85:U208"><span class="var type1" id="S44T85U438">p_B</span> = <span class="mxinfo " id="T85:U210">bsxfun(@rdivide, <span class="var type1" id="S19T85U443">p</span>, <span class="var type1" id="S43T214U444">lp</span>)</span></span> ;</span></span>
<span class="srcline"><span class="lineno"><a href="190,79" id="srcline79"> 79</a></span><span class="line">    <span class="mxinfo " id="T13:U213"><span class="var type1" id="S46T13U447">alpha_i</span> = <span class="mxinfo " id="T13:U215">reshape(<span class="mxinfo " id="T218:U216">sum(<span class="mxinfo " id="T217:U217">sum(<span class="var type1" id="S14T10U454">PI_i</span>,1)</span>,2)</span>, 1, <span class="var type1" id="S11T4U459">mixture_size</span>+1 )</span></span> ;</span></span>
<span class="srcline"><span class="lineno"><a href="190,80" id="srcline80"> 80</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="190,81" id="srcline81"> 81</a></span><span class="line">    <span class="comment">% Maximization on Guassian parameters</span></span></span>
<span class="srcline"><span class="lineno"><a href="190,82" id="srcline82"> 82</a></span><span class="line">    <span class="mxinfo " id="T13:U220"><span class="var type1" id="S46T13U463">alpha_i</span> = <span class="mxinfo " id="T13:U222"><span class="var type1" id="S46T13U465">alpha_i</span> / <span class="mxinfo " id="T4:U224">sum(<span class="var type1" id="S46T13U468">alpha_i</span>)</span></span></span> ;</span></span>
<span class="srcline"><span class="lineno"><a href="190,83" id="srcline83"> 83</a></span><span class="line">    <span class="comment">% estimate means and covs </span></span></span>
<span class="srcline"><span class="lineno"><a href="190,84" id="srcline84"> 84</a></span><span class="line">    <span class="keyword">for</span> <span class="var type1" id="S47T4U471">k</span> = <span class="mxinfo " id="T4:U227">1</span> : <span class="var type1" id="S11T4U474">mixture_size</span>  </span></span>
<span class="srcline"><span class="lineno"><a href="190,85" id="srcline85"> 85</a></span><span class="line">        <span class="mxinfo " id="T61:U229"><span class="var type1" id="S48T61U477">w_data</span> = <span class="mxinfo " id="T61:U231">bsxfun(@times, <span class="var type1" id="S4T61U482">data</span>, <span class="mxinfo " id="T214:U233"><span class="var type1" id="S44T85U484">p_B</span>(<span class="var type1" id="S47T4U485">k</span>,:)</span>)</span></span> ;</span></span>
<span class="srcline"><span class="lineno"><a href="190,86" id="srcline86"> 86</a></span><span class="line">        <span class="mxinfo " id="T6:U236"><span class="var type1" id="S49T6U489">x_mu</span> = <span class="mxinfo " id="T6:U238"><span class="mxinfo " id="T6:U239">sum( <span class="var type1" id="S48T61U493">w_data</span>, 2 )</span> / <span class="mxinfo " id="T4:U241">sum(<span class="mxinfo " id="T214:U242"><span class="var type1" id="S44T85U498">p_B</span>(<span class="var type1" id="S47T4U499">k</span>,:)</span>)</span></span></span> ;</span></span>
<span class="srcline"><span class="lineno"><a href="190,87" id="srcline87"> 87</a></span><span class="line">        <span class="mxinfo " id="T7:U245"><span class="var type1" id="S50T7U503">x_2_mu</span> = <span class="mxinfo " id="T7:U247"><span class="mxinfo " id="T7:U248"><span class="var type1" id="S4T61U506">data</span>*<span class="mxinfo " id="T83:U250"><span class="var type1" id="S48T61U508">w_data</span>'</span></span> / <span class="mxinfo " id="T4:U252">sum(<span class="mxinfo " id="T214:U253"><span class="var type1" id="S44T85U512">p_B</span>(<span class="var type1" id="S47T4U513">k</span>,:)</span>)</span></span></span> ;                </span></span>
<span class="srcline"><span class="lineno"><a href="190,88" id="srcline88"> 88</a></span><span class="line">        <span class="mxinfo " id="T7:U256"><span class="var type1" id="S51T7U517">c</span> = <span class="mxinfo " id="T7:U258"><span class="var type1" id="S50T7U519">x_2_mu</span> - <span class="mxinfo " id="T7:U260"><span class="var type1" id="S49T6U521">x_mu</span>*<span class="mxinfo " id="T75:U262"><span class="var type1" id="S49T6U523">x_mu</span>'</span></span></span></span> ;                </span></span>
<span class="srcline"><span class="lineno"><a href="190,89" id="srcline89"> 89</a></span><span class="line">        <span class="comment">% naiive update of mean and covariance</span></span></span>
<span class="srcline"><span class="lineno"><a href="190,90" id="srcline90"> 90</a></span><span class="line">        <span class="mxinfo " id="T7:U264"><span class="mxinfo " id="T7:U265"><span class="mxinfo " id="T15:U266"><span class="mxinfo " id="T5:U267"><span class="var type1" id="S2T1U529">detector_state</span>.current_mixture</span>(<span class="var type1" id="S47T4U531">k</span>)</span>.Cov</span> = <span class="var type1" id="S51T7U533">c</span></span> ; </span></span>
<span class="srcline"><span class="lineno"><a href="190,91" id="srcline91"> 91</a></span><span class="line">        <span class="mxinfo " id="T6:U271"><span class="mxinfo " id="T6:U272"><span class="mxinfo " id="T15:U273"><span class="mxinfo " id="T5:U274"><span class="var type1" id="S2T1U539">detector_state</span>.current_mixture</span>(<span class="var type1" id="S47T4U541">k</span>)</span>.Mu</span> = <span class="var type1" id="S49T6U543">x_mu</span></span> ;</span></span>
<span class="srcline"><span class="lineno"><a href="190,92" id="srcline92"> 92</a></span><span class="line">        <span class="mxinfo " id="T4:U278"><span class="mxinfo " id="T4:U279"><span class="mxinfo " id="T15:U280"><span class="mxinfo " id="T5:U281"><span class="var type1" id="S2T1U549">detector_state</span>.current_mixture</span>(<span class="var type1" id="S47T4U551">k</span>)</span>.w</span> = <span class="mxinfo " id="T4:U284"><span class="var type1" id="S46T13U554">alpha_i</span>(<span class="var type1" id="S47T4U555">k</span>)</span></span> ; </span></span>
<span class="srcline"><span class="lineno"><a href="190,93" id="srcline93"> 93</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="190,94" id="srcline94"> 94</a></span><span class="line">        <span class="comment">% update means with a static prior</span></span></span>
<span class="srcline"><span class="lineno"><a href="190,95" id="srcline95"> 95</a></span><span class="line">        <span class="keyword">if</span> <span class="mxinfo " id="T2:U287"><span class="var type1" id="S2T1U559">detector_state</span>.use_prior_on_mixture</span></span></span>
<span class="srcline"><span class="lineno"><a href="190,96" id="srcline96"> 96</a></span><span class="line">            <span class="mxinfo " id="T4:U289"><span class="var type1" id="S52T4U563">i_c_d</span> = <span class="var type1" id="S47T4U564">k</span></span> ; <span class="mxinfo " id="T4:U292"><span class="var type1" id="S53T4U567">i_c_0</span> = <span class="var type1" id="S47T4U568">k</span></span> ;</span></span>
<span class="srcline"><span class="lineno"><a href="190,97" id="srcline97"> 97</a></span><span class="line">            <span class="mxinfo " id="T6:U295"><span class="mxinfo " id="T6:U296"><span class="mxinfo " id="T15:U297"><span class="mxinfo " id="T5:U298"><span class="var type1" id="S2T1U574">detector_state</span>.current_mixture</span>(<span class="var type1" id="S52T4U576">i_c_d</span>)</span>.Mu</span> = <span class="mxinfo " id="T6:U301"><span class="fcn" id="F1240N18:B579">mergePd</span>( <span class="mxinfo " id="T6:U302"><span class="mxinfo " id="T15:U303"><span class="mxinfo " id="T5:U304"><span class="var type1" id="S2T1U583">detector_state</span>.current_mixture</span>(<span class="var type1" id="S52T4U585">i_c_d</span>)</span>.Mu</span>, <span class="mxinfo " id="T7:U307"><span class="mxinfo " id="T15:U308"><span class="mxinfo " id="T5:U309"><span class="var type1" id="S2T1U590">detector_state</span>.current_mixture</span>(<span class="var type1" id="S52T4U592">i_c_d</span>)</span>.Cov</span> , <span class="keyword">...</span></span></span></span></span>
<span class="srcline"><span class="lineno"><a href="190,98" id="srcline98"> 98</a></span><span class="line"><span class="mxinfo " id="T6:U295"><span class="mxinfo " id="T6:U301">                <span class="mxinfo " id="T6:U312"><span class="mxinfo " id="T15:U313"><span class="mxinfo " id="T5:U314"><span class="var type1" id="S2T1U597">detector_state</span>.prior_mixture</span>(<span class="var type1" id="S53T4U599">i_c_0</span>)</span>.Mu</span>,<span class="keyword">...</span></span></span></span></span>
<span class="srcline"><span class="lineno"><a href="190,99" id="srcline99"> 99</a></span><span class="line"><span class="mxinfo " id="T6:U295"><span class="mxinfo " id="T6:U301">                <span class="mxinfo " id="T7:U317"><span class="mxinfo " id="T15:U318"><span class="mxinfo " id="T5:U319"><span class="var type1" id="S2T1U604">detector_state</span>.prior_mixture</span>(<span class="var type1" id="S53T4U606">i_c_0</span>)</span>.Prec</span>)</span></span> ; </span></span>
<span class="srcline"><span class="lineno"><a href="190,100" id="srcline100">100</a></span><span class="line">        <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="190,101" id="srcline101">101</a></span><span class="line">    <span class="keyword">end</span>     </span></span>
<span class="srcline"><span class="lineno"><a href="190,102" id="srcline102">102</a></span><span class="line">     </span></span>
<span class="srcline"><span class="lineno"><a href="190,103" id="srcline103">103</a></span><span class="line">    <span class="mxinfo " id="T4:U322"><span class="var type1" id="S55T4U610">sum_w</span>=<span class="mxinfo " id="T4:U324">0</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="190,104" id="srcline104">104</a></span><span class="line">    <span class="keyword">for</span> <span class="var type1" id="S22T4U614">i</span>=<span class="mxinfo " id="T4:U326">1</span>:numel(<span class="var type1" id="S2T1U620">detector_state</span>.current_mixture),</span></span>
<span class="srcline"><span class="lineno"><a href="190,105" id="srcline105">105</a></span><span class="line">        <span class="mxinfo " id="T4:U328"><span class="var type1" id="S55T4U624">sum_w</span>=<span class="mxinfo " id="T4:U330"><span class="var type1" id="S55T4U626">sum_w</span>+<span class="mxinfo " id="T4:U332"><span class="mxinfo " id="T15:U333"><span class="mxinfo " id="T5:U334"><span class="var type1" id="S2T1U630">detector_state</span>.current_mixture</span>(<span class="var type1" id="S22T4U632">i</span>)</span>.w</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="190,106" id="srcline106">106</a></span><span class="line">    <span class="keyword">end</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="190,107" id="srcline107">107</a></span><span class="line"> </span></span>
<span class="srcline"><span class="lineno"><a href="190,108" id="srcline108">108</a></span><span class="line">    <span class="keyword">for</span> <span class="var type1" id="S47T4U636">k</span>=<span class="mxinfo " id="T4:U338">1</span>:<span class="var type1" id="S11T4U639">mixture_size</span>,</span></span>
<span class="srcline"><span class="lineno"><a href="190,109" id="srcline109">109</a></span><span class="line">        <span class="mxinfo " id="T4:U340"><span class="mxinfo " id="T4:U341"><span class="mxinfo " id="T15:U342"><span class="mxinfo " id="T5:U343"><span class="var type1" id="S2T1U645">detector_state</span>.current_mixture</span>(<span class="var type1" id="S47T4U647">k</span>)</span>.w</span> = <span class="mxinfo " id="T4:U346"><span class="mxinfo " id="T4:U347"><span class="mxinfo " id="T15:U348"><span class="mxinfo " id="T5:U349"><span class="var type1" id="S2T1U653">detector_state</span>.current_mixture</span>(<span class="var type1" id="S47T4U655">k</span>)</span>.w</span>/ <span class="var type1" id="S55T4U657">sum_w</span></span></span> ;</span></span>
<span class="srcline"><span class="lineno"><a href="190,110" id="srcline110">110</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="190,111" id="srcline111">111</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="190,112" id="srcline112">112</a></span><span class="line">     <span class="mxinfo " id="T4:U353"><span class="var type1" id="S17T4U660">cont</span> = <span class="mxinfo " id="T4:U355"><span class="var type1" id="S17T4U662">cont</span> - <span class="mxinfo " id="T4:U357">1</span></span></span> ;</span></span>
<span class="srcline"><span class="lineno"><a href="190,113" id="srcline113">113</a></span><span class="line"> <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="190,114" id="srcline114">114</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="190,115" id="srcline115">115</a></span><span class="line"><span class="mxinfo " id="T351:U358"><span class="var type1" id="S3T351U666">Q_sum_large</span> = <span class="var type1" id="S18T351U667">Q_sum</span></span> ;</span></span>
<span class="srcline"><span class="lineno"><a href="190,116" id="srcline116">116</a></span><span class="line"><span class="mxinfo " id="T10:U361"><span class="mxinfo " id="T10:U362"><span class="var type1" id="S2T1U671">detector_state</span>.PI_i</span> = <span class="mxinfo " id="T10:U364">reshape(<span class="var type1" id="S18T351U675">Q_sum</span>, 50, 50, 4)</span></span>; </span></span>
<span class="srcline"><span class="lineno"><a href="190,117" id="srcline117">117</a></span><span class="line"><span class="keyword">end</span></span></span>
</pre>
